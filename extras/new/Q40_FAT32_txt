USING QXL.WIN CONTAINERS ON FAT32 FORMATTED DRIVES
=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


      Introduction
I   - Using container files on the card
II  - Avoiding fragmentation
III - Naming scheme
IV  - The new WIN_DRIVE command
V   - The new WIN_CHECK command
VI  - The new CARD_DIR$ function
VII - The new CARD_CRUSH command


Introduction
=-=-=-=-=-=-

As of version  3.32 of SMSQ/E, the  Qx0 can use not  only the usual IDE
drives	with Atari and QDOS partitions, but also QXL.WIN type container
files on FAT32 formatted  media. Whilst  the intention	is to  use this
with  SDHC cards in appropriate adapters for easy data exchange between
the  Qx0 and the rest of the QL world, this doesn't have to be the case
necessarily: I	have  successfully  used  a  standard  IDE  hard  drive
formatted with a FAT 32 partition containing a QXL.WIN file on it.

Please note that the Qx0 does  not  read  FAT32  media	directly,  just
QXL.WIN files on such media.

Special attention must	be paid as  to how the	QXL.WIN container files
are  stored on the media. I'll use  SDHC cards in the appropriate adap-
ters as an example.

For  the cards to  be useful, they  must be partitioned  (with a normal
DOS  partition scheme, not as GPT) and the first primary partition must
be formatted in  FAT32 format  (this cannot  be done  on the  Qx0). The
different container files the Qx0 needs to access must be put into that
partition, which should be possible from any machine running an OS that
can  read/write SDHC cards (Linux, Windows, macOs): just copy the files
to  the card. As of version 3.36 of SMSQ/E, the files may lie in any of
the  first 4 primary partitions  of the card, if  they are formatted in
FAT32.
 

The Qx0  has two IDE extension card slots,  each one has two ports, one
master	and one slave. The ideal solution  would be that the "old" disk
remain	in the master position, the "new" disk (or card adapter) in the
slave  position. That way, any old SMSQE  could boot from the old disk,
load v. 3.32 (or later) of  SMSQ/E  and  then  use  the  new  disk.  Be
advised,  however, that it  has been reported  to me (and  I know first
hand)  that some card  adapters will only  work as masters  - and often
refuse to  be used with  a slave drive.  In that case,	you would need,
either	to boot from a floppy, or get a second IDE I/O card. You could,
of  course, also burn new Eproms. Note that, as of v. 3.33 of SMSQ/E, a
mechanism  is provided	for having  SMSQ/E compressed,	so that  it can
still fit in 256 KiB (see  the	file  smsq_q40_boot_doc  in  the  SMSQE
sources).



I - Using container files on the card
=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

As stated, the	QXL.WIN container files  must lie in  the first primary
partition  (or,  as  of  SMSQ/E  3.36,	any  of  the  first  4	primary
partitions) on	the media  which must  be formatted  with a  FAT32 file
system. Moreover, these container files  must  be  located  within  the
first 16 directory entries of this FAT32 formatted partition.

SMSQ/E for the Qx0 expects that all container files (i.e. files for WIN
drives) lie in	contiguous sectors  on the  media. If  this is	not the
case,  the file is said to be "fragmented". Fragmented files are deadly
here: SMSQ/E assumes that,  once  it  has  found  the  beginning  of  a
container  file, the  rest of  that container  file lies  in contiguous
sectors  on the  media/card, and  it will  cheerfully write  into those
contiguous sectors which it  deems still  belong to  that file.  If the
file is  fragmented, these contiguous sectors may  not belong to it but
to another file, which will thus be irretrievably corrupted.



II - Avoiding fragmentation
=-=-=-=-=-=-=-=-=-=-=-=-=-=

So,  special precautions must be taken	when writing the container (and
other) file(s) to  the media. The  best and recommended  way to achieve
this  is to make sure that, before writing the QXL.WIN files, the media
is  freshly formatted. Then, one after	the other, write each container
file to the  media immediately	after formatting  it. Once  the QXL.WIN
file is safely on the media, SMSQE will not cause file fragmentation in
the FAT32 system.

Note : practise has shown that in most cases it may not be necessary to
reformat the media. You could also  delete  every  single  file  on  it
before copying new files onto  it.  Under  no  circumstances,  however,
should you only delete files selectively: this may leave "holes" in the
file  allocation table and this leads to fragmented files. However, the
recommendation	still is to format the card  and not just to delete all
files from it.

When copying  several files to	the freshly formatted  media, make sure
that  the copy process of  each file is finished  before you start that
for the  next file. If not,  it may happen that  the two copy processes
write  concurrently to the media, which could mean that the sectors for
the two files  interleave. Depending  on the  operating system	you use
(linux, windows, mac  os) if  you drag	several files  to the  media at
once,  several concurrent copy	processes might be  started which might
lead  to file fragmentation. So, to avoid  this, just drag the files to
copy one after the other.

Never just  delete a single file  -be it a container  file or any other
file-	from the media,  but always format  it (or at  least delete ALL
files  from it), and then write the files  to it again: If you delete a
single file  from the card  and later write  another, bigger, container
file  to the card, it is possible that part of this container file will
lie in the sectors  previously occupied  by the  deleted file,	and the
rest  in  previously  unoccupied  sectors.  This  file	would  then  be
fragmented  and not lie in contiguous sectors on the card: a recipe for
a disaster.

If  a container file becomes fragmented, you WILL experience data loss,
and other files on the card might also be irrecoverably damaged!

Do not drag and drop several files onto the card at once. Do not delete
files from the card - always format it.

As  of version 3.36 of	SMSQ/E, a special command  is provided to check
that a container file is not fragmented (see WIN_CHECK below).



III - Naming scheme
=-=-=-=-=-=-==-=-=-

The  file name of a container file MUST be in "8.3" format, i.e. a name
of  1 to 8 characters, possibly followed by a decimal point and a three
letter	 extension.  Missing   letters	are   filled  up   with  spaces
automatically by the  system. The name	and extension must  be in upper
case (but  wee below) and the extension,  if present, must be separated
from the name by a period (".").

Please only use plain  ASCII characters  for the  name and  no accented
characters, i.e. the letters A-Z and numbers 0-9.

In all commands or configuration items where you must give or configure
a name, SMSQ/E tries to  help  you  as	much  as  possible.  Names  are
automatically  converted into  upper case  and correctly  formatted, so
that  "qlwa.win" would	automatically be  converted to	"QLWA    .WIN".
However, a "_" is not converted to a ".".



IV - The new WIN_DRIVE command
=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

To allow for QXL.WIN files to be used as container files, the WIN_DRIVE
command has been extended.

The previous scheme was : WIN_DRIVE n,t,u,p

where
n is the drive number.
t is the target number (from 0 -3).
u is the unit number (unused).
p is the partition number (from 0 to 3 only).

u and p may be omitted and will then default to 0.


This  scheme is, of course still valid if you want to use QLWA or Atari
partitions as before, so if you  do  not  use  the  new  facility,  the
WIN_DRIVE command remains unchanged.

If you do use it, append the drive name at the end:

Syntax:

WIN_DRIVE n,t,u,p,name$

In this case, the u and p parameters MUST be given, though they will be
ignored.  As of v. 3.36 of SMSQ/E, the partition parameter is no longer
ignored, and must indicate a valid primary partition (0 to 3).

Example :

     WIN_DRIVE 4,1,0,0,"QXL.WIN"

will set the file called QXL.WIN, to be found on the first partition of
the  FAT32 formatted drive in  target 1 (i.e. the  "slave" drive of the
first IDE slot), as WIN drive 4. Do not use any values other then 0 for
u (and, before version 3.36, for p).

     WIN_DRIVE 5,2,0,1,"QXL2.WIN"

will  set the file called QXL2.WIN, to be found on the second partition
of  the FAT32 formatted drive  in target 2 (i.e.  the "master" drive of
the  second IDE slot), as WIN drive 4. Do not use any values other then
0 for u (and, before version 3.36, for p).

The quotes are not necessary.

Any value other  than 0 -  3 for the  target or for  the partition will
cause a "bad parameter" error.



V - The new WIN_CHECK command
=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

This  keyword, introduced with SMSQ/E 3.36, allows you to check whether
a container  file on  a FAT32  formatted medium  is fragmented	or not.
Should the file turn out to be fragmented DO NOT USE IT!

Syntax:

WIN_CHECK drive_number

where drive_number is the number  of  the  win_drive  attached	to  the
container file (1 to 8, as usual).

This command  returns without error if the file  can be read and is not
fragmented.

If  the command returns with an error,	this means either that the file
cannot	be found, or that it is  fragmented. In rare cases, the command
might  return with an "out of memory" error if it couldn't allocate the
memory it needed to complete its mission.

Example:

     WIN_CHECK 1

will check that the file used as WIN1_ is OK.



VI  - The new CARD_DIR$ function
=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

This  function will return the names of the files in the first 16 slots
of the FAT32 directory of a partition on a card. This way, you can know
what name should be used for  a  container  file  to  be  used	in  the
WIN_DRIVE command.


Syntax:

result$ = CARD_DIR$(card_number[,partition])

where card number corresponds  to the  target +1  and partition  is the
partition number (from 0 to 3). The partition parameter is optional, if
omitted it defaults to partition 0.

On return,  result$ will contain a large  string with the 8.3 formatted
names  of  the	16  entries,  separated  between  them	by  a  linefeed
(CHR$(10)). These names may also be shown as "-- Empty -- " which means
that the  corresponding entry in the FAT32  root directory is empty, or"-Long name- " which means that this entry does not point to a file but
to  a FAT32 long name. The latter is  NOT considered by SMSQ/E to be an
empty  entry in the directory. Files with  long names cannot be used as
container files.


Examples:

     PRINT CARD_DIR$(1,0)


Will  display the names of the files found in the first 16 slots of the
directory of  partition 0 in  card 1 (which  is the card  in the master
position of the first IDE slot).


     PRINT CARD_DIR$(4,3)


Will  display the names of the files found in the first 16 slots of the
directory of partition 3  in card  4 (which  is the  card in  the slave
position of the second IDE slot).


VII - The new CARD_CRUSH command
=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

ATTENTION, this command is extremely dangerous.

This command will "crush" (fill with 0) the very first sector of a card
(the  master boot record,  MBR). ONCE THIS  IS DONE, THAT  CARD WILL BE
UNUSABLE, not only in the Qx0,	but  also  under  any  other  operating
system.

It will then need to be re-partitioned or re-formatted.

Under SMSQE on	the Qx0, the only  thing you could do  with such a card
would be to reformat it as a direct QLWA disk.




W. Lenerz
December 2017 - April 2020
