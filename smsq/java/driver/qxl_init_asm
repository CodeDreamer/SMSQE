; *****************************************************************
; SMSQ NFA Driver initialisation (c) W.Lenerz 2012
; This handles linking in the driver into the OS.
;
; copyright (C) w. Lenerz 2012	published under the SMSQE licence
;
; v. 0.01 functional
; v. 0.00 stub

; based on:
; RAM Disk disk initialisation	V2.02	 1985	Tony Tebby   QJUMP
; ******************************************************************


	section nfa

	xdef	qxl_init

	xref.l	nfa_vers	; get version

	xref	ut_procdef
	xref	iou_ddst
	xref	iou_ddlk


	xref	nfa_opn 	; open file
	xref	nfa_clo 	; close file
	xref	nfa_io		; do file io
	xref	nfa_fmt 	; format drive
	xref	nfa_niy

	include 'dev8_keys_iod'
	include 'dev8_mac_proc'
	include 'dev8_dd_rd_data'
	include 'dev8_keys_java'

;+++
; Initialise QXL_USE and DD linkage and get device going.
;
;	status return standard
;---
qxl_init
	lea	proctab,a1
	jsr	ut_procdef
	move.l	4,d0		; get config info
	beq.s	no_cfg
	move.l	a1,-(a7)
	move.l	d0,a1
	move.l	jva_winu(a1),d0
	beq.s	none
	lea	use_nam+2,a1
	move.l	d0,(a1)
none	move.l	(a7)+,a1
no_cfg	
	lea	nfa_vect,a3		  ; set up dd linkage
	jsr	iou_ddst
	jmp	iou_ddlk

nfa_vect
	dc.l	rdd_end 	; length of linkage
	dc.l	rdd.plen	; length of physical definition
use_nam dc.w	3,'QXL0'	; device name (usage)
	dc.w	3,'QXL0'	; device name (real)

null	dc.w	0		; external interrupt server (none)
	dc.w	0		; polling server (none)
	dc.w	0		; scheduler server  (none)

	dc.w	nfa_io-*	; io operations
	dc.w	nfa_opn-*	; open operation
	dc.w	nfa_clo-*	; close
	dc.w	0		; forced slaving
	dc.w	0		; dummy
	dc.w	0		; dummy
	dc.w	nfa_fmt-*	; format

	dc.w	0		; check all slave blocks read
	dc.w	0		; flush all buffers
	dc.w	0		; get occupancy information
	dc.w	0		; load
	dc.w	0		; save
	dc.w	0		; truncate
	dc.w	0		; locate buffer
	dc.w	0		; locate / allocate buffer
	dc.w	0		; mark buffer updated
	dc.w	0		; allocate first sector
	dc.w	0		; check medium for open operation
	dc.w	0		; format drive
	dc.w	0		; read sector
	dc.w	0		; write sector
	dc.w	-1

; the basic procedures
; v 0.00 none is impemented
	section procs

proctab
	proc_stt
	proc_def QXL_USE
	proc_end
	proc_stt
	proc_def QXL_USE$ , qxl_useq
	proc_end
	end
